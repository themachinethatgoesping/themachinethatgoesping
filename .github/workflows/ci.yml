# SPDX-FileCopyrightText: 2022 Peter Urban, Ghent University
#
# SPDX-License-Identifier: CC0-1.0

name: CI

on:
  push:
    branches: [ main ]
    #paths:
    #  - "**meson.build"
    #  - "**.cpp"
    #  - "**.c"
    #  - "**.h"
  pull_request:
    branches: [ main ]
    #paths:
    #  - "**meson.build"
    #  - "**.cpp"
    #  - "**.c"
    #  - "**.h"

# env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  #BUILD_TYPE: Release
  
jobs:

  build-on-ubuntu-22_04:
    runs-on: ubuntu-latest
    container: ubuntu:22.04 #pull directly from dockerhub

    steps:
    - name: install prequisits
      run: apt update && apt-get install -y sudo git

    - name: checkout main repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: install dependecies (c++)
      run: sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential ccache pkg-config cmake python3-pip libboost-all-dev libcurl4-openssl-dev

    - name: install dependcies (meson & pythone)
      run: pip install meson ninja pytest

    - name: configure meson
      run: meson setup builddir/; meson configure builddir -Dpython.install_env=auto -Dprefix=/usr/;
      env:
        CC: gcc

    - name: compile project
      run: meson compile -C builddir/

    - name: test (cpp)
      run: meson test -C builddir/ -v

    - name: install project
      run: meson install -C builddir/

    - name: test (pytest)
      run: pytest -v
      
    - uses: actions/upload-artifact@v1
      if: failure()
      with:
        name: Ubuntu_22.04_Testlog
        path: builddir/meson-logs/testlog.txt
        

  build-on-ubuntu-20_04:
    runs-on: ubuntu-latest
    container: ubuntu:20.04 #pull directly from dockerhub   

    steps:
    - name: install prequisits
      run: apt update && apt-get install -y sudo git

    - name: checkout main repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: install dependecies (c++)
      run: sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential ccache pkg-config cmake python3-pip libboost-all-dev libcurl4-openssl-dev

    - name: install dependcies (meson & pythone)
      run: pip install meson ninja pytest

    - name: configure meson
      run: meson setup builddir/; meson configure builddir -Dpython.install_env=auto -Dprefix=/usr/;
      env:
        CC: gcc

    - name: compile project
      run: meson compile -C builddir/

    - name: test (cpp)
      run: meson test -C builddir/ -v

    - name: install project
      run: meson install -C builddir/

    - name: test (pytest)
      run: pytest -v
      
    - uses: actions/upload-artifact@v1
      if: failure()
      with:
        name: Ubuntu_20.04_Testlog
        path: builddir/meson-logs/testlog.txt  


  build-on-archlinux:
    runs-on: ubuntu-latest
    container: archlinux:latest #pull directly from dockerhub   

    steps:
    - name: install prequisits
      run: pacman -Syu --noconfirm; pacman -Syy sudo git --noconfirm

    - name: checkout main repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: install dependecies (c++)
      run: sudo pacman -Syy --noconfirm base-devel ccache pkg-config cmake python-pip boost curl

    - name: install dependecies (meson & python)
      run: pip install meson ninja pytest
      
    - name: configure meson
      run: meson setup builddir/; meson configure builddir -Dpython.install_env=auto -Dprefix=/usr/;
      env:
        CC: gcc

    - name: compile project
      run: meson compile -C builddir/

    - name: test (cpp)
      run: meson test -C builddir/ -v

    - name: install project
      run: meson install -C builddir/

    - name: test (pytest)
      run: pytest -v
      
    - uses: actions/upload-artifact@v1
      if: failure()
      with:
        name: archlinux_Testlog
        path: builddir/meson-logs/testlog.txt
    

#   build-on-windows:
#     runs-on: windows-latest
#     steps:
#     - uses: actions/checkout@v1
#     - uses: actions/setup-python@v1
#       with:
#         python-version: '3.x'
#     - run: pip install meson ninja
#     - run: meson setup builddir/
#       env:
#         CC: gcc
#     - run: meson test -C builddir/ -v
#     - uses: actions/upload-artifact@v1
#       if: failure()
#       with:
#         name: Windows_Meson_Testlog
#         path: builddir/meson-logs/testlog.txt

#   macos:
#     runs-on: macos-latest
#     steps:
#     - uses: actions/checkout@v1
#     - uses: actions/setup-python@v1
#       with:
#         python-version: '3.x'
#     - run: brew install gcc
#     - run: pip install meson ninja
#     - run: meson setup builddir/
#       env:
#         CC: gcc
#     - run: meson test -C builddir/ -v
#     - uses: actions/upload-artifact@v1
#       if: failure()
#       with:
#         name: MacOS_Meson_Testlog
#         path: builddir/meson-logs/testlog.txt

      
